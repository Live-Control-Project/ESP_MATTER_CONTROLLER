# ESP matter Controller

This example creates a Matter Controller using the ESP Matter data model.

See the [docs](https://docs.espressif.com/projects/esp-matter/en/latest/esp32/developing.html) for more information about building and flashing the firmware.

## Additional Environment Setup

No additional setup is required.

## Controller Example

See the [docs](https://docs.espressif.com/projects/esp-matter/en/latest/esp32/developing.html#controller-example) for more information
about pairing and controling an end-device using this example

## Flash

### ESP Gateway board integrates the ESP32-S3 SoC and the ESP32-H2 RCP

### Hardware Platform

See the [docs](https://github.com/espressif/esp-thread-br#hardware-platforms) for more information about the hardware platform.

Flash ESP32-H2 RCP <a href="https://espressif.github.io/esp-launchpad/?flashConfigURL=https://live-control-project.github.io/bin/config.toml">
<img alt="Try it with ESP Launchpad" src="https://espressif.github.io/esp-launchpad/assets/try_with_launchpad.png" width="250" height="70">
</a>

![alt text](screen/esp-board_h2.jpg?raw=true)

Flash ESP32-S3 controller <a href="https://espressif.github.io/esp-launchpad/?flashConfigURL=https://live-control-project.github.io/bin/config.toml">
<img alt="Try it with ESP Launchpad" src="https://espressif.github.io/esp-launchpad/assets/try_with_launchpad.png" width="250" height="70">
</a>

![alt text](screen/esp-board_s3.jpg?raw=true)

### ESP32-C6

### Hardware Platform

See the [docs](https://www.espressif.com/en/products/socs/esp32-c6) for more information about the hardware platform.

Flash ESP32-C6 controller
<a href="https://espressif.github.io/esp-launchpad/?flashConfigURL=https://live-control-project.github.io/bin/config.toml">
<img alt="Try it with ESP Launchpad" src="https://espressif.github.io/esp-launchpad/assets/try_with_launchpad.png" width="250" height="70">
</a>

## Build Windows

![alt text](screen/Build_Windows.jpg?raw=true)

## Build Linux

ESP Gateway board

```
idf.py -D  set-target esp32s3 build
idf.py -p <PORT> erase-flash flash monitor
```

ESP32-C6

```
idf.py -D  set-target esp32c6 build
idf.py -p <PORT> erase-flash flash monitor
```

### Using

- Connect controller to Wi-Fi network with device console

```
wifi {ssid} {password}
```

- Connect controller to MQTT network with device console

```
mqtt mqtt://mqtt_server.com:1883 {prefix} -u {mqtt_user_name} -p {mqtt_user_password}
```

### MQTT API

## MQTT comand topic: {preffix}/command/matter

- Reboot controller

```
{
  "action":"reboot"
}
```

- Matter factory reset

```
{
  "action":"factoryreset"
}
```

- Initializing a new Thread network dataset and commit it as active one

```
{
  "action":"initOpenThread"
}
```

- Getting operational dataset TLV-encoded string.

```
{
  "action":"getTLVs"
}
```

## MQTT comand pairing

```
{
  "action": "pairing",
  "payload": <payloadStr>
}
```

# payloadStr

```
ble-thread <node_id> <dataset_tlvs> <pincode> <discriminator>
```

```
ble-wifi <node_id> <ssid> <password> <pincode> <discriminator>
```

```
onnetwork <node_id> <setup_passcode>
```

```
code <node_id> <setup_payload>
```

```
code-wifi <node_id> <ssid> <passphrase> <setup_payload>
```

```
code-thread <node_id> <operationalDataset> <setup_payload>
```

```
code-wifi-thread <node_id> <ssid> <passphrase> <operationalDataset> <setup_payload>
```

## MQTT control comand

- Control end-device (On/Off cluster Toggle command) (See the [docs](https://docs.espressif.com/projects/esp-matter/en/latest/esp32/developing.html) for more information)

```
{
  "action": "invoke-cmd",
  "payload": "<node-id | group-id> <endpoint-id> <cluster-id> <command-id> <command-data>"
}
```

- Read attribute

```
{
  "action": "read-attr",
  "payload": "<node-id> <endpoint-ids> <cluster-ids> <attribute-ids>"
}
```

- Read event

```
{
  "action": "read-event",
  "payload": "<node-id> <endpoint-ids> <cluster-ids> <event-ids>"
}
```

- Write attribute (See the [docs](https://docs.espressif.com/projects/esp-matter/en/latest/esp32/developing.html) for more information)

```
{
  "action": "write-attr",
   "payload": "<node-id> <endpoint-id> <cluster-ids> <attribute-ids> <attribute-value>"
}
```

- Command to subscribe to device attributes

```
{
  "action": "subs-attr",
  "payload": "<node-id> <endpoint-ids> <cluster-ids> <attribute-ids> <min-interval> <max-interval>"
}
```

## A1 Appendix FAQs

### A1.1 Pairing Command Failed

I cannot finish the commissioning on the controller example:

- For onnetwork pairing, please make sure that the end-device and the controller are on the same IP-network.
- The controller uses the hard-code test PAA certification so the PAI and DAC on the end-device should be generated by the [test cert](https://github.com/espressif/connectedhomeip/blob/4f7669b052b16bd054227376e1bbadac85419793/credentials/test/attestation/Chip-Test-PAA-NoVID-Cert.pem) and the [test key](https://github.com/espressif/connectedhomeip/blob/4f7669b052b16bd054227376e1bbadac85419793/credentials/test/attestation/Chip-Test-PAA-NoVID-Key.pem)

### A1.2 Command Send Failed

I cannot send commands to the light from the controller:

- Make sure the pairing command was a success.
- Currently the cluster commands and write-attribute commands are only supported for on-off, level-control, and color-control clusters.
- The CASESession will be lost on end-device after reboot. But the controller will still send commands on the previous CASESession. The controller will release previous CASESession after the last command is timeout. So the second command will re-establish a new CASESession in this situation.
